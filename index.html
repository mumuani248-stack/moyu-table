<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <title>å¢¨é›¨ç¬™èŠ±ç™¾æ¥­æˆ°é…ç½®è¡¨ - é€±æœ«åˆ†æ¡ˆç‰ˆ</title>
    <style>
        body { font-family: sans-serif; background: #f0f2f5; padding: 20px; }
        .container { max-width: 1200px; margin: auto; }
        
        /* è¼¸å…¥å€å„ªåŒ– */
        .input-section { background: #fff; padding: 20px; border-radius: 12px; box-shadow: 0 4px 6px rgba(0,0,0,0.1); margin-bottom: 20px; }
        .input-group { display: flex; gap: 10px; flex-wrap: wrap; align-items: center; margin-bottom: 15px; }
        input, select { padding: 10px; border: 1px solid #ddd; border-radius: 6px; }
        
        /* æ¨™ç±¤æ¨£å¼ */
        .day-check { display: inline-flex; align-items: center; gap: 5px; background: #eee; padding: 5px 12px; border-radius: 20px; cursor: pointer; transition: 0.3s; }
        .day-check:has(input:checked) { background: #d1e7ff; color: #007bff; border: 1px solid #007bff; }

        /* çœ‹æ¿æ¨£å¼ */
        .board { display: flex; gap: 20px; overflow-x: auto; padding-bottom: 20px; }
        .column { background: #ebedef; border-radius: 12px; width: 380px; min-height: 600px; padding: 15px; display: flex; flex-direction: column; flex-shrink: 0; }
        .column h2 { text-align: center; margin-top: 0; color: #444; border-bottom: 2px solid #ddd; padding-bottom: 10px; }
        .stat-bar { background: #fff; padding: 5px 10px; border-radius: 6px; font-size: 0.85rem; margin-bottom: 10px; color: #666; text-align: center; }

        .item-list { flex-grow: 1; min-height: 500px; }
        .item-list.drag-over { background: #dfe3e6; border: 2px dashed #007bff; border-radius: 8px; }

        /* å¡ç‰‡æ¨£å¼ */
        .card { 
            background: white; border-radius: 8px; padding: 12px; margin-bottom: 12px; 
            box-shadow: 0 2px 5px rgba(0,0,0,0.08); cursor: grab; 
            border-left: 8px solid #007bff; position: relative;
        }
        .card:active { cursor: grabbing; }
        .card .name { font-weight: bold; font-size: 1.1rem; display: block; margin-bottom: 5px; }
        .card .info { font-size: 0.9rem; color: #555; }
        .card .team-badge { display: inline-block; padding: 2px 8px; border-radius: 4px; font-size: 0.75rem; margin-top: 8px; background: #f0f0f0; }
        
        .del-btn { position: absolute; top: 8px; right: 8px; background: #ff4d4d; color: white; border: none; border-radius: 50%; width: 22px; height: 22px; cursor: pointer; }

        /* é¡è‰²å€åˆ† */
        .badge-t1 { background: #e3f2fd; color: #1976d2; border: 1px solid #bbdefb; }
        .badge-t2 { background: #f3e5f5; color: #7b1fa2; border: 1px solid #e1bee7; }
        
        #output { width: 100%; height: 150px; display: none; margin-top: 15px; border-radius: 8px; }
    </style>
</head>
<body>

<div class="container">
    <h1>ğŸŒ¸ å¢¨é›¨ç¬™èŠ± - å‘¨æœ«æˆ°åŠ›é…ç½®è¡¨</h1>
    
    <div class="input-section">
        <div class="input-group">
            <input type="text" id="pName" placeholder="æˆå“¡åç¨±">
            <input type="number" id="pPower" placeholder="æˆ°åŠ›æ•¸å€¼">
            <select id="pStyle">
                <option value="">é¸æ“‡æµæ´¾</option>
                <option value="å¨å¨">å¨å¨</option>
                <option value="ç‰ç‰">ç‰ç‰</option>
                <option value="éœ–éœ–">éœ–éœ–</option>
                <option value="ç„¡å">ç„¡å</option>
                <option value="ä¹ä¹">ä¹ä¹</option>
                <option value="é›™åˆ€">é›™åˆ€</option>
            </select>
            <select id="pInitTeam">
                <option value="team1">é è¨ˆç·¨å…¥ï¼šä¸€éšŠ</option>
                <option value="team2">é è¨ˆç·¨å…¥ï¼šäºŒéšŠ</option>
            </select>
        </div>
        <div class="input-group">
            <label class="day-check"><input type="checkbox" name="pDay" value="å…­"> æ˜ŸæœŸå…­å¯åƒåŠ </label>
            <label class="day-check"><input type="checkbox" name="pDay" value="æ—¥"> æ˜ŸæœŸæ—¥å¯åƒåŠ </label>
            <button id="addBtn" style="background: #007bff; margin-left: 20px;">åŠ å…¥åå–®</button>
            <span id="countTip" style="font-size: 0.9rem; color: #888;"></span>
        </div>
    </div>

    <div class="board">
        <div class="column" data-state="pool">
            <h2>å¾…åˆ†é…æ± </h2>
            <div class="stat-bar" id="stat-pool">äººæ•¸: 0</div>
            <div class="item-list" id="pool"></div>
        </div>
        
        <div class="column" data-state="sat">
            <h2>æ˜ŸæœŸå…­é…ç½®</h2>
            <div class="stat-bar" id="stat-sat">ç¸½æˆ°åŠ›: 0 | éšŠä¼äººæ•¸: 0</div>
            <div class="item-list" id="sat"></div>
        </div>
        
        <div class="column" data-state="sun">
            <h2>æ˜ŸæœŸæ—¥é…ç½®</h2>
            <div class="stat-bar" id="stat-sun">ç¸½æˆ°åŠ›: 0 | éšŠä¼äººæ•¸: 0</div>
            <div class="item-list" id="sun"></div>
        </div>
    </div>

    <div style="text-align:center; margin-top:30px; gap:10px; display:flex; justify-content:center;">
        <button id="exportBtn" style="background: #28a745;">è¼¸å‡ºé€±æœ«åˆ†é…çµæœ</button>
        <button id="resetBtn" style="background: #6c757d;">æ¸…ç©ºåˆ†é…ç‹€æ…‹</button>
    </div>
    <textarea id="output"></textarea>
</div>

<script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
    import { getDatabase, ref, push, onValue, update, remove, set } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-database.js";

    const firebaseConfig = {
        apiKey: "AIzaSyAV08lkRKtqclvDoju-cSmmN85fAM5fD-E",
        authDomain: "project1-efdf0.firebaseapp.com",
        projectId: "project1-efdf0",
        storageBucket: "project1-efdf0.firebasestorage.app",
        messagingSenderId: "667848051314",
        appId: "1:667848051314:web:f8ed8e50a13ced394250eb",
        measurementId: "G-5QPWW9CQ7H",
        databaseURL: "https://project1-efdf0-default-rtdb.asia-southeast1.firebasedatabase.app"
    };

    const app = initializeApp(firebaseConfig);
    const db = getDatabase(app);
    const playersRef = ref(db, 'players_v2'); // ä½¿ç”¨æ–°ç‰ˆè·¯å¾‘

    const getStyleColor = (s) => ({'ä¹ä¹':'#00008B','ç„¡å':'#87CEFA','å¨å¨':'#FFA500','éœ–éœ–':'#32CD32','ç‰ç‰':'#006400','é›™åˆ€':'#800080'}[s] || '#007bff');

    // åŠ å…¥æˆå“¡
    document.getElementById('addBtn').onclick = () => {
        const name = document.getElementById('pName').value;
        const power = parseInt(document.getElementById('pPower').value);
        const style = document.getElementById('pStyle').value;
        const team = document.getElementById('pInitTeam').value;
        const days = Array.from(document.querySelectorAll('input[name="pDay"]:checked')).map(n => n.value);

        if (!name || isNaN(power) || !style) return alert("è«‹å®Œæ•´å¡«å¯«åç¨±ã€æˆ°åŠ›èˆ‡æµæ´¾");
        if (days.length === 0) return alert("âš ï¸ å¿…é ˆå‹¾é¸å…­æˆ–æ—¥ï¼");

        push(playersRef, { name, power, style, days, team, state: 'pool' });
        document.getElementById('pName').value = '';
        document.getElementById('pPower').value = '';
        document.querySelectorAll('input[name="pDay"]').forEach(el => el.checked = false);
    };

    // ç›£è½èˆ‡æ¸²æŸ“
    onValue(playersRef, (snapshot) => {
        const lists = { pool: document.getElementById('pool'), sat: document.getElementById('sat'), sun: document.getElementById('sun') };
        const stats = { pool: 0, sat: {p:0, c:0}, sun: {p:0, c:0} };
        Object.values(lists).forEach(l => l.innerHTML = '');

        if (snapshot.exists()) {
            const data = snapshot.val();
            for (let key in data) {
                const p = data[key];
                if (!lists[p.state]) continue;

                // çµ±è¨ˆè¨ˆç®—
                if (p.state === 'pool') stats.pool++;
                else { stats[p.state].p += p.power; stats[p.state].c++; }

                const card = document.createElement('div');
                card.className = "card"; card.draggable = true; card.id = key;
                card.style.borderLeftColor = getStyleColor(p.style);
                
                const teamLabel = p.team === 'team1' ? 'ä¸€éšŠ' : 'äºŒéšŠ';
                const teamClass = p.team === 'team1' ? 'badge-t1' : 'badge-t2';

                card.innerHTML = `
                    <button class="del-btn">âœ•</button>
                    <span class="name">${p.name} <small style="color:#888; font-weight:normal;">[${p.days.join('')}]</small></span>
                    <div class="info">æˆ°åŠ›: ${p.power.toLocaleString()} | ${p.style}</div>
                    <div class="team-badge ${teamClass}">${teamLabel}</div>
                `;

                card.querySelector('.del-btn').onclick = () => remove(ref(db, `players_v2/${key}`));
                card.ondragstart = (e) => e.dataTransfer.setData("text", e.target.id);
                lists[p.state].appendChild(card);
            }
        }
        // æ›´æ–°çµ±è¨ˆæ–‡å­—
        document.getElementById('stat-pool').innerText = `å¾…åˆ†é…äººæ•¸: ${stats.pool}`;
        document.getElementById('stat-sat').innerText = `ç¸½æˆ°åŠ›: ${stats.sat.p.toLocaleString()} | äººæ•¸: ${stats.sat.c}`;
        document.getElementById('stat-sun').innerText = `ç¸½æˆ°åŠ›: ${stats.sun.p.toLocaleString()} | äººæ•¸: ${stats.sun.c}`;
    });

    // æ‹–æ”¾é‚è¼¯
    document.querySelectorAll('.column').forEach(col => {
        const list = col.querySelector('.item-list');
        list.ondragover = (e) => { e.preventDefault(); list.classList.add('drag-over'); };
        list.ondragleave = () => list.classList.remove('drag-over');
        list.ondrop = (e) => {
            const id = e.dataTransfer.getData("text");
            update(ref(db, `players_v2/${id}`), { state: col.dataset.state });
            list.classList.remove('drag-over');
        };
    });

    // é‡ç½®èˆ‡è¼¸å‡º (ç•¥ï¼Œé‚è¼¯åŒå‰ï¼Œä½†é‡å° state åšè™•ç†)
    document.getElementById('resetBtn').onclick = () => {
        if(confirm("ç¢ºå®šé‡ç½®æ‰€æœ‰äººçš„åˆ†é…ç‹€æ…‹ï¼Ÿ")) {
            onValue(playersRef, (snap) => {
                const updates = {};
                for(let k in snap.val()) updates[`players_v2/${k}/state`] = 'pool';
                update(ref(db), updates);
            }, {onlyOnce: true});
        }
    };
</script>

</body>
</html>
