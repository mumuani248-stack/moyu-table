<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <title>å¢¨é›¨ç¬™èŠ± - é€±æœ«åˆ†èº«é…ç½®ç‰ˆ</title>
    <style>
        body { font-family: sans-serif; background: #f4f7f6; padding: 20px; margin: 0; }
        .container { max-width: 1600px; margin: auto; }
        
        /* å¸ƒå±€ */
        .main-layout { display: flex; gap: 20px; align-items: flex-start; }
        
        /* å·¦å´ï¼šå¾…åˆ†é…åå–®å›ºå®š */
        .member-pool { 
            width: 300px; background: #dee2e6; padding: 15px; border-radius: 12px; 
            position: sticky; top: 20px; height: 85vh; display: flex; flex-direction: column;
        }
        
        /* å³å´ï¼šæˆ°å ´å››éšŠ */
        .battle-board { flex-grow: 1; display: grid; grid-template-columns: 1fr 1fr; gap: 20px; }
        
        .column { background: #e9ecef; border-radius: 10px; padding: 12px; min-height: 400px; }
        .sat { background: #fff0f3; border: 1px solid #ffccd5; }
        .sun { background: #f0f4ff; border: 1px solid #d0d7ff; }

        .stat-bar { background: rgba(255,255,255,0.7); padding: 5px; text-align: center; font-size: 0.8rem; margin-bottom: 10px; font-weight: bold; border-radius: 5px; }

        /* å¡ç‰‡æ¨£å¼ */
        .card { 
            background: white; border-radius: 6px; padding: 10px; margin-bottom: 8px; 
            box-shadow: 0 2px 4px rgba(0,0,0,0.05); position: relative; border-left: 6px solid #007bff;
        }
        .pool-card { cursor: default; }
        .pool-card:hover { background: #f8f9fa; }
        
        .add-to-team { 
            margin-top: 5px; display: flex; gap: 4px; flex-wrap: wrap; 
        }
        .add-btn { 
            font-size: 11px; padding: 2px 5px; cursor: pointer; background: #007bff; color: white; border: none; border-radius: 3px;
        }
        .add-btn.btn-sun { background: #6f42c1; }

        .del-btn { position: absolute; top: 5px; right: 5px; background: #ff4d4d; color: white; border: none; border-radius: 50%; width: 18px; height: 18px; cursor: pointer; font-size: 10px; }

        .item-list { min-height: 350px; }
        .name { font-weight: bold; font-size: 0.95rem; }
        .info { font-size: 0.8rem; color: #666; }
        .tag { font-size: 0.75rem; color: #d63384; font-weight: bold; }
    </style>
</head>
<body>

<div class="container">
    <h1 style="text-align: center;">ğŸŒ¸ å¢¨é›¨ç¬™èŠ± - é€±æœ«åˆ†èº«é…ç½®è¡¨</h1>

    <div class="main-layout">
        <div class="member-pool">
            <h3>æ‰€æœ‰æˆå“¡åå–®</h3>
            <div id="input-area" style="margin-bottom: 15px;">
                <input type="text" id="pName" placeholder="åå­—" style="width:70px">
                <input type="number" id="pPower" placeholder="æˆ°åŠ›" style="width:70px">
                <select id="pStyle"><option value="ä¹ä¹">ä¹ä¹</option><option value="ç„¡å">ç„¡å</option><option value="å¨å¨">å¨å¨</option><option value="éœ–éœ–">éœ–éœ–</option><option value="ç‰ç‰">ç‰ç‰</option><option value="é›™åˆ€">é›™åˆ€</option></select>
                <div style="font-size: 12px; margin-top:5px;">
                    <label><input type="checkbox" name="pDay" value="å…­">å…­</label>
                    <label><input type="checkbox" name="pDay" value="æ—¥">æ—¥</label>
                    <button id="addBtn" style="float:right">æ–°å¢</button>
                </div>
            </div>
            <div id="pool" style="overflow-y: auto; flex-grow: 1;"></div>
        </div>

        <div class="battle-board">
            <div class="column sat">
                <h2>å…­ - ä¸€éšŠ</h2>
                <div class="stat-bar" id="stat-sat1">æˆ°åŠ›: 0 | 0äºº</div>
                <div class="item-list" id="sat1"></div>
            </div>
            <div class="column sat">
                <h2>å…­ - äºŒéšŠ</h2>
                <div class="stat-bar" id="stat-sat2">æˆ°åŠ›: 0 | 0äºº</div>
                <div class="item-list" id="sat2"></div>
            </div>
            <div class="column sun">
                <h2>æ—¥ - ä¸€éšŠ</h2>
                <div class="stat-bar" id="stat-sun1">æˆ°åŠ›: 0 | 0äºº</div>
                <div class="item-list" id="sun1"></div>
            </div>
            <div class="column sun">
                <h2>æ—¥ - äºŒéšŠ</h2>
                <div class="stat-bar" id="stat-sun2">æˆ°åŠ›: 0 | 0äºº</div>
                <div class="item-list" id="sun2"></div>
            </div>
        </div>
    </div>
</div>

<script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
    import { getDatabase, ref, push, onValue, update, remove, set } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-database.js";

    const firebaseConfig = {
        apiKey: "AIzaSyAV08lkRKtqclvDoju-cSmmN85fAM5fD-E",
        authDomain: "project1-efdf0.firebaseapp.com",
        projectId: "project1-efdf0",
        storageBucket: "project1-efdf0.firebasestorage.app",
        messagingSenderId: "667848051314",
        appId: "1:667848051314:web:f8ed8e50a13ced394250eb",
        measurementId: "G-5QPWW9CQ7H",
        databaseURL: "https://project1-efdf0-default-rtdb.asia-southeast1.firebasedatabase.app"
    };

    const app = initializeApp(firebaseConfig);
    const db = getDatabase(app);
    const membersRef = ref(db, 'members');    // å­˜åŸå§‹åå–®
    const assignmentsRef = ref(db, 'assigns'); // å­˜åˆ†é…çµæœ

    const getStyleColor = (s) => ({'ä¹ä¹':'#00008B','ç„¡å':'#87CEFA','å¨å¨':'#FFA500','éœ–éœ–':'#32CD32','ç‰ç‰':'#006400','é›™åˆ€':'#800080'}[s] || '#007bff');

    // æ–°å¢æˆå“¡åˆ°ç¸½åå–®
    document.getElementById('addBtn').onclick = () => {
        const name = document.getElementById('pName').value;
        const power = parseInt(document.getElementById('pPower').value);
        const style = document.getElementById('pStyle').value;
        const days = Array.from(document.querySelectorAll('input[name="pDay"]:checked')).map(n => n.value);
        if (!name || isNaN(power) || days.length === 0) return alert("è«‹å¡«å¯«å®Œæ•´ä¸¦å‹¾é¸å…­æˆ–æ—¥");
        push(membersRef, { name, power, style, days });
    };

    // ç›£è½ç¸½åå–®
    onValue(membersRef, (snapshot) => {
        const pool = document.getElementById('pool');
        pool.innerHTML = '';
        if (snapshot.exists()) {
            const data = snapshot.val();
            for (let id in data) {
                const m = data[id];
                const card = document.createElement('div');
                card.className = 'card pool-card';
                card.style.borderLeftColor = getStyleColor(m.style);
                
                // æ ¹æ“šå‹¾é¸é¡¯ç¤ºæŒ‰éˆ•
                let btns = '';
                if (m.days.includes('å…­')) {
                    btns += `<button class="add-btn" onclick="assign('${id}','sat1')">å…­1</button>`;
                    btns += `<button class="add-btn" onclick="assign('${id}','sat2')">å…­2</button>`;
                }
                if (m.days.includes('æ—¥')) {
                    btns += `<button class="add-btn btn-sun" onclick="assign('${id}','sun1')">æ—¥1</button>`;
                    btns += `<button class="add-btn btn-sun" onclick="assign('${id}','sun2')">æ—¥2</button>`;
                }

                card.innerHTML = `
                    <button class="del-btn" onclick="removeMember('${id}')">âœ•</button>
                    <div class="name">${m.name} <span class="tag">[${m.days.join('')}]</span></div>
                    <div class="info">${m.power} | ${m.style}</div>
                    <div class="add-to-team">${btns}</div>
                `;
                pool.appendChild(card);
            }
        }
    });

    // ç›£è½åˆ†é…çµæœ
    onValue(assignmentsRef, (snapshot) => {
        const teams = { sat1:[], sat2:[], sun1:[], sun2:[] };
        const stats = { sat1:0, sat2:0, sun1:0, sun2:0 };
        document.querySelectorAll('.item-list').forEach(l => l.innerHTML = '');

        if (snapshot.exists()) {
            const data = snapshot.val();
            for (let aid in data) {
                const a = data[aid];
                const teamList = document.getElementById(a.targetTeam);
                if (!teamList) continue;

                stats[a.targetTeam] += a.power;
                const card = document.createElement('div');
                card.className = 'card';
                card.style.borderLeftColor = getStyleColor(a.style);
                card.innerHTML = `
                    <button class="del-btn" onclick="unassign('${aid}')">âœ•</button>
                    <div class="name">${a.name}</div>
                    <div class="info">${a.power} | ${a.style}</div>
                `;
                teamList.appendChild(card);
            }
        }
        // æ›´æ–°çµ±è¨ˆ
        for(let t in stats) {
            document.getElementById(`stat-${t}`).innerText = `æˆ°åŠ›: ${stats[t].toLocaleString()} | ${document.getElementById(t).children.length}äºº`;
        }
    });

    // åˆ†é…é‚è¼¯ï¼šå°‡æˆå“¡åˆ†èº«åŠ å…¥éšŠä¼
    window.assign = (mid, teamId) => {
        const memberRef = ref(db, `members/${mid}`);
        onValue(memberRef, (snap) => {
            const m = snap.val();
            push(assignmentsRef, { ...m, memberId: mid, targetTeam: teamId });
        }, { onlyOnce: true });
    };

    // ç§»é™¤åˆ†é…
    window.unassign = (aid) => remove(ref(db, `assigns/${aid}`));
    
    // å¾¹åº•åˆªé™¤æˆå“¡
    window.removeMember = (mid) => {
        if(confirm("å°‡å¾ç¸½åå–®åˆªé™¤æ­¤äººï¼ŒéšŠä¼ä¸­çš„ç´€éŒ„ä¹Ÿæœƒä¸€ä½µæ¸…é™¤å—ï¼Ÿ")) {
            remove(ref(db, `members/${mid}`));
            // æ¸…ç†è©²æˆå“¡çš„æ‰€æœ‰åˆ†é…
            get(assignmentsRef).then(snap => {
                if(snap.exists()) {
                    const data = snap.val();
                    for(let aid in data) {
                        if(data[aid].memberId === mid) remove(ref(db, `assigns/${aid}`));
                    }
                }
            });
        }
    };
</script>

</body>
</html>
