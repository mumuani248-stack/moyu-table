<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <title>å¢¨é›¨ç¬™èŠ±ç™¾æ¥­æˆ° - é€±æœ«å››éšŠé…ç½®è¡¨</title>
    <style>
        body { font-family: sans-serif; background: #f4f7f6; margin: 0; padding: 20px; }
        .container { max-width: 1600px; margin: auto; }
        h1 { text-align: center; color: #444; margin-bottom: 25px; }

        /* è¼¸å…¥å€æ¨£å¼ */
        .input-section { 
            background: #fff; padding: 20px; border-radius: 12px; 
            box-shadow: 0 4px 10px rgba(0,0,0,0.05); margin-bottom: 20px;
            display: flex; gap: 15px; align-items: center; justify-content: center; flex-wrap: wrap;
        }
        input, select { padding: 10px; border: 1px solid #ddd; border-radius: 6px; }
        .day-check { display: inline-flex; align-items: center; gap: 5px; cursor: pointer; font-size: 0.9rem; }
        button { padding: 10px 20px; cursor: pointer; border: none; border-radius: 6px; font-weight: bold; transition: 0.3s; }
        #addBtn { background: #007bff; color: white; }
        #addBtn:hover { background: #0056b3; }

        /* çœ‹æ¿ä½ˆå±€ */
        .board { display: flex; gap: 12px; align-items: flex-start; overflow-x: auto; padding-bottom: 20px; }
        
        /* æ¯ä¸€æ¬„çš„å¯¬åº¦èˆ‡é¡è‰² */
        .column { 
            background: #e9ecef; border-radius: 10px; width: 300px; 
            min-height: 700px; padding: 12px; display: flex; flex-direction: column; flex-shrink: 0;
        }
        .column.pool { background: #dee2e6; } /* å¾…åˆ†é…æ¬„è‰² */
        .column.sat { background: #fff0f3; border: 1px solid #ffccd5; } /* é€±å…­è‰²ç³» */
        .column.sun { background: #f0f4ff; border: 1px solid #d0d7ff; } /* é€±æ—¥è‰²ç³» */

        .column h2 { text-align: center; font-size: 1.1rem; margin: 0 0 10px 0; color: #333; }
        
        /* æˆ°åŠ›åŠ ç¸½æ¢ */
        .stat-bar { 
            background: rgba(255,255,255,0.7); padding: 6px; border-radius: 6px; 
            font-size: 0.8rem; text-align: center; margin-bottom: 12px; color: #555; font-weight: bold;
        }

        /* åˆ—è¡¨å€ */
        .item-list { flex-grow: 1; min-height: 550px; }
        .item-list.drag-over { background: rgba(0,123,255,0.1); border: 2px dashed #007bff; border-radius: 8px; }

        /* æˆå“¡å¡ç‰‡ */
        .card { 
            background: white; border-radius: 8px; padding: 12px; margin-bottom: 10px; 
            box-shadow: 0 2px 4px rgba(0,0,0,0.05); cursor: grab; 
            border-left: 8px solid #007bff; position: relative;
        }
        .card:active { cursor: grabbing; }
        .card .name { font-weight: bold; display: block; margin-bottom: 4px; }
        .card .info { font-size: 0.85rem; color: #666; }
        .card .days-tag { font-size: 0.75rem; color: #d63384; font-weight: bold; }
        
        .del-btn { 
            position: absolute; top: 6px; right: 6px; background: #ff4d4d; color: white; 
            border: none; border-radius: 50%; width: 20px; height: 20px; font-size: 10px; cursor: pointer; 
        }

        .action-btns { text-align: center; margin-top: 20px; }
        #output { width: 100%; height: 120px; display: none; margin-top: 15px; border-radius: 8px; border: 1px solid #ccc; padding: 10px; }
    </style>
</head>
<body>

<div class="container">
    <h1>ğŸŒ¸ å¢¨é›¨ç¬™èŠ±ç™¾æ¥­æˆ° - é€±æœ«å››éšŠé…ç½®</h1>

    <div class="input-section">
        <input type="text" id="pName" placeholder="æˆå“¡åç¨±">
        <input type="number" id="pPower" placeholder="æˆ°åŠ›">
        <select id="pStyle">
            <option value="">é¸æ“‡æµæ´¾</option>
            <option value="å¨å¨">å¨å¨</option><option value="ç‰ç‰">ç‰ç‰</option><option value="éœ–éœ–">éœ–éœ–</option>
            <option value="ç„¡å">ç„¡å</option><option value="ä¹ä¹">ä¹ä¹</option><option value="é›™åˆ€">é›™åˆ€</option>
        </select>
        <div style="display: flex; flex-direction: column; gap: 5px;">
            <label class="day-check"><input type="checkbox" name="pDay" value="å…­"> æ˜ŸæœŸå…­</label>
            <label class="day-check"><input type="checkbox" name="pDay" value="æ—¥"> æ˜ŸæœŸæ—¥</label>
        </div>
        <button id="addBtn">åŠ å…¥å¾…åˆ†é…</button>
    </div>

    <div class="board">
        <div class="column pool" data-state="pool">
            <h2>å¾…åˆ†é…æ± </h2>
            <div class="stat-bar" id="stat-pool">äººæ•¸: 0</div>
            <div class="item-list" id="pool"></div>
        </div>

        <div class="column sat" data-state="sat1">
            <h2>å…­ - ã€ä¸€éšŠã€‘</h2>
            <div class="stat-bar" id="stat-sat1">æˆ°åŠ›: 0 | 0äºº</div>
            <div class="item-list" id="sat1"></div>
        </div>

        <div class="column sat" data-state="sat2">
            <h2>å…­ - ã€äºŒéšŠã€‘</h2>
            <div class="stat-bar" id="stat-sat2">æˆ°åŠ›: 0 | 0äºº</div>
            <div class="item-list" id="sat2"></div>
        </div>

        <div class="column sun" data-state="sun1">
            <h2>æ—¥ - ã€ä¸€éšŠã€‘</h2>
            <div class="stat-bar" id="stat-sun1">æˆ°åŠ›: 0 | 0äºº</div>
            <div class="item-list" id="sun1"></div>
        </div>

        <div class="column sun" data-state="sun2">
            <h2>æ—¥ - ã€äºŒéšŠã€‘</h2>
            <div class="stat-bar" id="stat-sun2">æˆ°åŠ›: 0 | 0äºº</div>
            <div class="item-list" id="sun2"></div>
        </div>
    </div>

    <div class="action-btns">
        <button id="exportBtn" style="background: #28a745; color:white;">è¼¸å‡ºæœ€çµ‚é…ç½®</button>
        <button id="resetBtn" style="background: #6c757d; color:white; margin-left: 10px;">å…¨éƒ¨å›å¾…åˆ†é…</button>
    </div>
    <textarea id="output"></textarea>
</div>

<script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
    import { getDatabase, ref, push, onValue, update, remove, get } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-database.js";

    const firebaseConfig = {
        apiKey: "AIzaSyAV08lkRKtqclvDoju-cSmmN85fAM5fD-E",
        authDomain: "project1-efdf0.firebaseapp.com",
        projectId: "project1-efdf0",
        storageBucket: "project1-efdf0.firebasestorage.app",
        messagingSenderId: "667848051314",
        appId: "1:667848051314:web:f8ed8e50a13ced394250eb",
        measurementId: "G-5QPWW9CQ7H",
        databaseURL: "https://project1-efdf0-default-rtdb.asia-southeast1.firebasedatabase.app"
    };

    const app = initializeApp(firebaseConfig);
    const db = getDatabase(app);
    const playersRef = ref(db, 'players_quad'); // å››éšŠå°ˆç”¨è·¯å¾‘

    const getStyleColor = (s) => ({'ä¹ä¹':'#00008B','ç„¡å':'#87CEFA','å¨å¨':'#FFA500','éœ–éœ–':'#32CD32','ç‰ç‰':'#006400','é›™åˆ€':'#800080'}[s] || '#007bff');

    // æ–°å¢æˆå“¡
    document.getElementById('addBtn').onclick = () => {
        const name = document.getElementById('pName').value;
        const power = parseInt(document.getElementById('pPower').value);
        const style = document.getElementById('pStyle').value;
        const days = Array.from(document.querySelectorAll('input[name="pDay"]:checked')).map(n => n.value);

        if (!name || isNaN(power) || !style) return alert("è«‹å®Œæ•´å¡«å¯«åç¨±ã€æˆ°åŠ›èˆ‡æµæ´¾");
        if (days.length === 0) return alert("âš ï¸ å¿…é ˆå‹¾é¸èƒ½å‡ºå¸­çš„æ™‚é–“ï¼ˆå…­ã€æ—¥ï¼‰ï¼");

        push(playersRef, { name, power, style, days, state: 'pool' });
        
        document.getElementById('pName').value = '';
        document.getElementById('pPower').value = '';
        document.querySelectorAll('input[name="pDay"]').forEach(el => el.checked = false);
    };

    // æ¸²æŸ“èˆ‡çµ±è¨ˆ
    onValue(playersRef, (snapshot) => {
        const ids = ['pool', 'sat1', 'sat2', 'sun1', 'sun2'];
        const lists = {}; ids.forEach(id => lists[id] = document.getElementById(id));
        const dataStats = {}; ids.forEach(id => dataStats[id] = { p: 0, c: 0 });

        Object.values(lists).forEach(l => l.innerHTML = '');

        if (snapshot.exists()) {
            const data = snapshot.val();
            for (let key in data) {
                const p = data[key];
                if (!lists[p.state]) continue;

                dataStats[p.state].p += p.power;
                dataStats[p.state].c++;

                const card = document.createElement('div');
                card.className = "card"; card.draggable = true; card.id = key;
                card.style.borderLeftColor = getStyleColor(p.style);
                
                card.innerHTML = `
                    <button class="del-btn">âœ•</button>
                    <span class="name">${p.name} <span class="days-tag">[${p.days.join('')}]</span></span>
                    <div class="info">æˆ°åŠ›: ${p.power.toLocaleString()} | ${p.style}</div>
                `;

                card.querySelector('.del-btn').onclick = () => remove(ref(db, `players_quad/${key}`));
                card.ondragstart = (e) => e.dataTransfer.setData("text", e.target.id);
                lists[p.state].appendChild(card);
            }
        }

        // æ›´æ–°å„æ¬„ä½çµ±è¨ˆæ–‡å­—
        ids.forEach(id => {
            const bar = document.getElementById(`stat-${id}`);
            if (id === 'pool') bar.innerText = `äººæ•¸: ${dataStats[id].c}`;
            else bar.innerText = `æˆ°åŠ›: ${dataStats[id].p.toLocaleString()} | ${dataStats[id].c}äºº`;
        });
    });

    // æ‹–æ”¾è¨­å®š
    document.querySelectorAll('.column').forEach(col => {
        const list = col.querySelector('.item-list');
        list.ondragover = (e) => { e.preventDefault(); list.classList.add('drag-over'); };
        list.ondragleave = () => list.classList.remove('drag-over');
        list.ondrop = (e) => {
            const id = e.dataTransfer.getData("text");
            update(ref(db, `players_quad/${id}`), { state: col.dataset.state });
            list.classList.remove('drag-over');
        };
    });

    // å…¨éƒ¨å›å¾…åˆ†é…
    document.getElementById('resetBtn').onclick = async () => {
        if(!confirm("ç¢ºå®šè¦å°‡æ‰€æœ‰äººç§»å›å¾…åˆ†é…æ± å—ï¼Ÿ")) return;
        const snap = await get(playersRef);
        if(!snap.exists()) return;
        const updates = {};
        for(let k in snap.val()) updates[`players_quad/${k}/state`] = 'pool';
        update(ref(db), updates);
    };

    // è¼¸å‡º
    document.getElementById('exportBtn').onclick = () => {
        let res = "--- å¢¨é›¨ç¬™èŠ±ç™¾æ¥­æˆ°æœ€çµ‚é…ç½® ---\n\n";
        const titles = { sat1: "ã€é€±å…­ä¸€éšŠã€‘", sat2: "ã€é€±å…­äºŒéšŠã€‘", sun1: "ã€é€±æ—¥ä¸€éšŠã€‘", sun2: "ã€é€±æ—¥äºŒéšŠã€‘", pool: "ã€æœªåˆ†é…ã€‘" };
        
        ['sat1', 'sat2', 'sun1', 'sun2', 'pool'].forEach(id => {
            res += titles[id] + "\n";
            const cards = document.getElementById(id).getElementsByClassName('card');
            if(cards.length === 0) res += "(ç„¡)\n";
            for(let c of cards) {
                res += `- ${c.querySelector('.name').innerText} (${c.querySelector('.info').innerText})\n`;
            }
            res += "\n";
        });
        const out = document.getElementById('output');
        out.value = res; out.style.display = 'block';
        alert("é…ç½®å·²ç”Ÿæˆï¼Œè«‹è¦‹ä¸‹æ–¹æ¡†æ ¼");
    };
</script>

</body>
</html>
